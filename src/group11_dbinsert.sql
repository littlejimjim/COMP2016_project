CREATE TABLE Students(
	sno CHAR(10),
	name CHAR(20),
	gender CHAR(1),
	major CHAR(20),
PRIMARY KEY (sno));

CREATE TABLE Books(
	call_no CHAR(10),
	ISBN CHAR(10),
	title CHAR(20),
	author CHAR(20),
	amount INTEGER,
	location CHAR(10),
	UNIQUE (call_no),
	PRIMARY KEY (ISBN));



(Many to Many Relationships?)
CREATE TABLE Borrow(
	b_date DATE,
	d_date DATE,
	book CHAR(20),
	borrower CHAR(10),
	PRIMARY KEY (book, borrower),
	FOREIGN KEY (book) REFERENCES Books(call_no),
	FOREIGN KEY (borrower) REFERENCES Students(sno));

(One to Many Relationships?)
CREATE TABLE Reserve(
	sno CHAR(10),
	book CHAR(20),
	reserveDate DATE
	PRIMARY KEY (sno),
FOREIGN KEY (sno) REFERENCES Student,
	FOREIGN KEY (book) REFERENCES Books(call_no));

CREATE TABLE Renew(
	sno CHAR(10),
	Book CHAR(20),
	PRIMARY KEY (sno, book)
	FOREIGN KEY (sno) REFERENCES Student,
	FOREIGN KEY (book) REFERENCES Books(call_no));

COMMIT;

CREATE OR REPLACE TRIGGER Borrow_constraint
BEFORE INSERT OR UPDATE ON Borrow
FOR EACH ROW
BEGIN
IF (:NEW.b_date > :NEW.d_date) THEN
RAISE_APPLICATION_ERROR(-20000, ‘Invalid date’);
END IF;
END;
/

(Count the amount of books student has borrow)
CREATE OR REPLACE TRIGGER Borrow_INSERT
AFTER INSERT ON Borrow
FOR EACH ROW
DECLARE
c INTEGER;
BEGIN
SELECT COUNT(*) into c FROM Students
WHERE sno = :NEW.sno;
IF(c = 0) THEN
INSERT INTO Students VALUES(:NEW.sno, 1);
ELSE
UPDATE Students SET bor_cnt = bor_cnt + 1
WHERE sno = :NEW.sno;
END IF;
END;
/

(Return book amount)
CREATE OR REPLACE TRIGGER Borrow_DELETE
AFTER DELETE ON Borrow
FOR EACH ROW
DECLARE
c INTEGER;
BEGIN
SELECT bor_cnt into c FROM Students
WHERE sno = :OLD.sno;
IF(c = 1) THEN
DELETE FROM Students
WHERE sno = :OLD.sno;
ELSE
UPDATE Students SET bor_cnt = bor_cnt -1
WHERE sno = :OLD.sno;
END IF;
END;
/

COMMIT;

INSERT INTO Students VALUES('12345678', 'A', 'M', 'Comp');
INSERT INTO Students VALUES('11111111', 'B', 'M', 'Math');
INSERT INTO Students VALUES('22222222', 'C', 'F', 'COMM');
INSERT INTO Students VALUES('33333333', 'D', 'F', 'COMM');
INSERT INTO Students VALUES('44444444', 'E', 'M', 'Comp');
INSERT INTO Students VALUES('55555555', 'F', 'M', 'COMM');
INSERT INTO Students VALUES('66666666', 'G', 'F', 'Math');
INSERT INTO Students VALUES('77777777', 'H', 'M', 'Comp');

INSERT INTO Books VALUES('A0000', '0306406151', 'AA', 'XX', 0, 'S1E01');
INSERT INTO Books VALUES('B0000', '0306406152', 'BB', 'YY', 0, 'S1E02');
INSERT INTO Books VALUES('C1111', '0306406153', 'CC', 'ZZ', 2, 'D1E11');
INSERT INTO Books VALUES('B0001', '0306406154', 'DD', 'UU', 2, 'G1E00');
INSERT INTO Books VALUES('A1111', '0306406155', 'EE', 'VV', 2, 'B1E00');
INSERT INTO Books VALUES('D0101', '0306406156', 'FF', 'WW', 1, 'B2E11');
INSERT INTO Books VALUES('E0000', '0306406157', 'GG', 'PP', 0, 'X0E22');
INSERT INTO Books VALUES('E0100', '0306406158', 'HH', 'QQ', 2, 'X0E21');
INSERT INTO Books VALUES('E0111', '0306406159', 'II', 'RR', 0, 'X0E44');

INSERT INTO Borrow VALUES('11111111', 'D0101', '24/03/2022', '21/04/2022')
INSERT INTO Borrow VALUES('55555555', 'A1111', '23/03/2022', '20/04/2022')
INSERT INTO Borrow VALUES('22222222', 'B0000', '31/03/2022', '12/05/2022')
INSERT INTO Borrow VALUES('11111111', 'A0000', '01/04/2022', '29/04/2022')
INSERT INTO Borrow VALUES('33333333', 'B0000', '03/04/2022', '15/05/2022')
INSERT INTO Borrow VALUES('11111111', 'C1111', '20/04/2022', '20/04/2022')
INSERT INTO Borrow VALUES('44444444', 'C1111', '20/04/2022', '20/04/2022')
INSERT INTO Borrow VALUES('44444444', 'A0000', '20/04/2022', '20/04/2022')
INSERT INTO Borrow VALUES('33333333', 'C1111', '20/04/2022', '20/04/2022')
INSERT INTO Borrow VALUES('33333333', 'A1111', '20/04/2022', '20/04/2022')
INSERT INTO Borrow VALUES('33333333', 'B0001', '20/04/2022', '20/04/2022')
INSERT INTO Borrow VALUES('44444444', 'D0101', '20/04/2022', '20/04/2022')
INSERT INTO Borrow VALUES('33333333', 'D0101', '20/04/2022', '20/04/2022')
INSERT INTO Borrow VALUES('44444444', 'A1111', '20/04/2022', '20/04/2022')
INSERT INTO Borrow VALUES('55555555', 'C1111', '20/04/2022', '20/04/2022')
INSERT INTO Borrow VALUES('22222222', 'E0111', '20/04/2022', '20/04/2022')
INSERT INTO Borrow VALUES('11111111', 'E0000', '20/04/2022', '20/04/2022')
INSERT INTO Borrow VALUES('44444444', 'B0001', '20/04/2022', '20/04/2022')

INSERT INTO Reserve VALUES('12345678', 'A0000', '20/04/2022')
INSERT INTO Reserve VALUES('66666666', 'E0000', '22/04/2022')

INSERT INTO Renew VALUES('22222222', 'B0000')
INSERT INTO Renew VALUES('11111111', 'B0000')
INSERT INTO Renew VALUES('44444444', 'C1111')
